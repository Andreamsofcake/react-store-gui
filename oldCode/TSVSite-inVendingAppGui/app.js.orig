'use strict';

// Declare app level module which depends on views, and components
var app = angular.module('myApp', [
        'ngRoute',
        'translation',
        'avt',
        'myApp.view0',
        'myApp.view1',
        'myApp.view2',
        'myApp.Card_Vending',
        'myApp.Cash_Vending',
        'myApp.Cashless_Vending',
        'myApp.THANKYOU_MSG',
        'myApp.Admin_Login',
        'myApp.Admin_Home',
        'myApp.Admin_Inventory',
        'myApp.Admin_System_Info',
        'myApp.Admin_Jofemar_Exerciser',
        'myApp.Admin_Component_Control',
        'myApp.Admin_Check_Faults',
        'myApp.Admin_Vms',
        'myApp.Admin_Auto_Map',
        'myApp.Cash_Card',
        'myApp.Vend_Error',
        'myApp.Admin_Settings',
        'myApp.version'
]);

app.run(function() {
        FastClick.attach(document.body, { touchBoundary: 200, tapDelay: 100 });
});

app.config(['$routeProvider', function($routeProvider) {
  $routeProvider.otherwise({redirectTo: '/view0'});
}]);


app.controller('mainController', ['$rootScope', '$location', 'TSVService', 'translate', '$timeout', '$filter',
    function($rootScope, $location, TSVService, translate, $timeout, $filter) {
        console.log("Hi Ping Ping Ping");
        $rootScope.credit = TSVService.session.creditBalance;
        $rootScope.bShowLanguage = false;
        $rootScope.bShowCredit = false;
        $rootScope.bCashless = false;

        if(Object.getOwnPropertyNames(TSVService.cache.machineSettings).length === 0){
            TSVService.cache.machineSettings = TSVService.fetchAllMachineSettings();
        }
        if(Object.getOwnPropertyNames(TSVService.cache.custommachinesettings).length === 0){
            TSVService.cache.custommachinesettings = TSVService.fetchAllCustomSettings();
        }

        //Run translation if selected language changes
        $rootScope.translate = function(name){
            return translate.translate(null, name);
        };

<<<<<<< HEAD
    $rootScope.localizedImage = function(name) {
        return translate.localizedPath(name);
    };

    $rootScope.creditMessage = function() {
=======
        $rootScope.creditMessage = function() {
>>>>>>> 50b6596020a6b77e29bc327ae40dc3b5510a4956

            if ($rootScope.bCashless) {
                return $rootScope.translate("BalanceLabel") + ": " + $filter('currency')($rootScope.fundsAvailable);
            } else {
                return $rootScope.translate("CreditLabel") + ": " + $filter('currency')($rootScope.credit);
            }
        };

        $rootScope.clickFlag = function(lang){
            console.log("clickFlag Clicked!"+lang);

            if(document.getElementById(lang).className == "hideflag"){
                document.getElementById(lang).className = "showflag";
                if (lang == "En"){
                    document.getElementById("Fr").className = "hideflag";
                }else{
                    document.getElementById("En").className = "hideflag";
                }
            }

            $rootScope.selectedLanguage = lang;
            translate.selectLanguage(lang);
        };

        //Init
        var lan = (!TSVService.cache.custommachinesettings.languageDefaulted || TSVService.cache.custommachinesettings.languageDefaulted=="")?"En":(TSVService.cache.custommachinesettings.languageDefaulted);
        $rootScope.clickFlag(lan);

        //Don't display the language button if no other language supported
        if(!TSVService.cache.custommachinesettings.languageSupported){
            $rootScope.bShowLanguageFlag = false;
        }else{
            var languages = TSVService.cache.custommachinesettings.languageSupported.split(";");
            if(languages.length > 1){
                $rootScope.bShowLanguageFlag = true;
            }else{
                $rootScope.bShowLanguageFlag = false;
            }
        }
}]);